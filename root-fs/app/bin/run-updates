#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

timestamp=$(date +%Y%m%d%H%M%S)
appDir=/app/bluespice/w

baseVersion=""
if [ -f /data/bluespice/logs/baseversion ]; then
	baseVersion=$(cat /data/bluespice/logs/baseversion)
fi
version=$(cat $appDir/BLUESPICE-VERSION)

if [ "$baseVersion" == "$version" ]; then
	echo "No version change, skipping updates"
	exit 0
fi

echo "Running updates"
echo "Version: $version"

run-maintenance update \
	--quick \
	--doshared \
	| tee -a /data/bluespice/logs/update-$timestamp.log

echo $version > /data/bluespice/logs/baseversion

if [ "${EDITION}" == "farm" ]; then
	run-maintenance BlueSpiceWikiFarm:RunForAll \
		--script='maintenance/update.php' \
		--args='--quick --doshared' \
		| tee -a /data/bluespice/logs/update-$timestamp.log
fi

for f in /app/bin/postupdate.d/*; do
	logFile=/data/bluespice/logs/postupdate/$(basename $f).log
	errorLogFile=/data/bluespice/logs/postupdate/$(basename $f).$timestamp.error.log
	if [ -f "$logFile" ]; then
		echo "Log file $logFile already exists, skipping $f"
		continue
	fi

	if [ -f "$f" ]; then
		echo ""
		echo "ðŸ”§ Running $f"
		$f \
			| tee -a $logFile
		if [ $? -ne 0 ]; then
			echo "Error running $f"
			mv $logFile $errorLogFile
			exit 1
		fi
	fi
done
